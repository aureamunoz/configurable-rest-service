<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My service</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
</head>
<body>

<div class="container">
    <h1>My service</h1>
    <div class="row">
        <div class="col-6 col-md-12 p-100">
            <form>
                <div class="mb-3">
                    <label for="responseDelay" class="form-label">Response delay [ms]</label>
                    <input type="number" class="form-control" id="responseDelay" min="0" max="10000" step="100"
                           onchange="updateSettings()">
                </div>
                <div class="mb-3">
                    <input type="checkbox" class="form-check-input" id="forceErrors" onchange="updateSettings()">
                    <label for="forceErrors" class="form-check-label">Enforce errors</label>
                </div>
            </form>
        </div>
        <div class="col-6 col-md-12">
            <div>
                <canvas id="myChart"></canvas>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const DELAY = 'responseDelay';
    const ENFORCE_ERRORS = 'forceErrors';

    let delayElt = document.getElementById(DELAY);
    let forceErrorsElt = document.getElementById(ENFORCE_ERRORS);

    function readSettings() {
        fetch("/config")
            .then(response => response.json())
            .then(data => {
                delayElt.value = data.delay;
                forceErrorsElt.checked = data.forceErrors;
            })
    }

    function updateSettings() {
        const delay = delayElt.value;
        const forceErrors = forceErrorsElt.checked;
        const config = {
            delay: delay,
            forceErrors: forceErrors
        };

        fetch("/config", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(config)
        }).then(resp => {
            console.log("update result", resp);
        })
    }

    readSettings()


    fetch("/stats")
        .then(response => response.json())
        .then(data => {
            console.log(data);
            let freqMap = new Map(); // mstodo would updating the map update the chart?

            data.requestTimes.forEach(
                event => {
                    let key = Math.floor((data.currentTime - event) / 100);
                    let count = freqMap.get(key) || 0;
                    freqMap.set(key, ++count)
                }
            )
            var ctx = document.getElementById("myChart").getContext('2d');
            var myLineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [...freqMap.keys()],
                    datasets: [{
                        label: 'Requests per 100ms',
                        data: [...freqMap.values()]
                    }],
                },
                options: {
                    elements: {
                        line: {
                            tension: 0
                        }
                    },
                    scales: {
                        yAxes: [{
                            ticks: {
                                beginAtZero: true,
                                stepSize: 1
                            }
                        }]
                    }
                }
            });
        })
    /*var a = ['2018-01-03 15:15:04', '2018-01-04 06:32:45', '2018-01-04 23:32:45', '2018-02-23 01:24:32', '2018-02-23 04:33:12', '2018-03-23 05:33:12', '2018-03-22 08:33:12', '2018-04-27 01:33:12'];

    var freqMap = new Map();

    a.forEach(function (time) {
        var date = new Date(time);
        var monthName = date.toLocaleString("en-us", {
            month: "short"
        });

        var key = monthName + "-" + date.getFullYear();
        var count = freqMap.get(key) || 0;
        freqMap.set(key, ++count);
    });

    var ctx = document.getElementById("myChart").getContext('2d');
    var myLineChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [...freqMap.keys()],
            datasets: [{
                label: 'Requests per month',
                data: [...freqMap.values()]
            }],
        },
        options: {
            elements: {
                line: {
                    tension: 0
                }
            },
            scales: {
                yAxes: [{
                    ticks: {
                        beginAtZero: true,
                        stepSize: 1
                    }
                }]
            }
        }
    });*/
</script>

</body>
</html>